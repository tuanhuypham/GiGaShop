
@{
    ViewData["Title"] = "Detail Product";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<div class="section padding_layout_1 product_detail">
    <div class="container">
        <div class="row">
            <div class="col-md-9">
                <div class="row">
                    <div class="col-xl-6 col-lg-12 col-md-12">
                        <div class="product_detail_feature_img hizoom hi2">
                            <img id="product-image" src="" alt="Product Image" class="img-responsive"> <!-- Hình ảnh sản phẩm -->
                        </div>
                    </div>
                    <div class="col-xl-6 col-lg-12 col-md-12 product_detail_side detail_style1">
                        <p id="product-id">ID sản phẩm: <span></span></p>
                        <div class="product-heading">
                            <h2 id="product-name">Norton Internet Security</h2>
                        </div>
                        <div class="product-detail-side">
                            <p id="product-price"></p>
                            <div id="product-rating">Đánh giá sản phẩm sẽ được hiển thị ở đây</div>
                            <p id="product-specifications">Thông số kỹ thuật sẽ được hiển thị ở đây</p>
                        </div>
                        <div class="detail-contant">
                            <p id="product-description">Mô tả sản phẩm sẽ được hiển thị ở đây</p>
                            <form id="add-to-cart-form">
                                @Html.AntiForgeryToken()
                                <div class="quantity">
                                    <input id="quantity-input" step="1" min="1" max="5" name="quantity" value="1" title="Qty" class="input-text qty text" size="4" type="number">
                                </div>
                                <button type="button" id="add-to-cart-btn" class="btn sqaure_bt">Add to cart</button>
                            </form>
                        </div>
                        <div class="share-post">
                            <a href="#" class="share-text">Share</a>
                            <ul class="social_icons">
                                <li><a href="#"><i class="fa fa-facebook" aria-hidden="true"></i></a></li>
                                <li><a href="#"><i class="fa fa-twitter" aria-hidden="true"></i></a></li>
                                <li><a href="#"><i class="fa fa-google-plus" aria-hidden="true"></i></a></li>
                                <li><a href="#"><i class="fa fa-instagram" aria-hidden="true"></i></a></li>
                                <li><a href="#"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li>
                            </ul>
                        </div>
                    </div>

                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="full">
                            <div class="tab_bar_section">
                                <ul class="nav nav-tabs" role="tablist">
                                    <li class="nav-item"> <a class="nav-link active" data-toggle="tab" href="#description">Description</a> </li>
                                    <li class="nav-item"> <a class="nav-link" data-toggle="tab" href="#reviews">Reviews</a> </li>
                                </ul>
                                <!-- Tab panes -->
                                <div class="tab-content">
                                    <div id="description" class="tab-pane active">
                                        <div class="product_desc">
                                            <p>

                                            </p>
                                        </div>
                                    </div>
                                    <div id="reviews" class="tab-pane fade">
                                        <div class="product_review">
                                            <h3>Reviews</h3>
                                            <div id="reviews-list">
                                                <!-- Đánh giá sẽ được hiển thị ở đây -->
                                            </div>
                                            <div class="row">
                                                <div class="col-sm-12">
                                                    <div class="full review_bt_section">
                                                        <div class="float-right"> <a class="btn sqaure_bt" data-toggle="collapse" href="#collapseExample" role="button" aria-expanded="false" aria-controls="collapseExample">Leave a Review</a> </div>
                                                    </div>
                                                    <div class="full">
                                                        <!-- Form đánh giá sản phẩm -->
                                                        <div id="collapseExample" class="full collapse commant_box">
                                                            <form id="review-form" method="post" action="@Url.Action("AddReview", "Home")">
                                                                @Html.AntiForgeryToken()
                                                                <input type="hidden" name="productId" value="@Model.ProductID" />
                                                                <select id="ratingSelect" name="rating" required>
                                                                    <option value="1">1 - Rất tệ</option>
                                                                    <option value="2">2 - Tệ</option>
                                                                    <option value="3">3 - Bình thường</option>
                                                                    <option value="4">4 - Tốt</option>
                                                                    <option value="5">5 - Tuyệt vời</option>
                                                                </select>
                                                                <textarea class="form-control" cols="50" id="new-review" name="comment" placeholder="Nhập đánh giá của bạn..." required></textarea>
                                                                <button class="btn sqaure_bt" type="submit">Lưu đánh giá</button>
                                                            </form>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="side_bar">
                    <div class="side_bar_blog">
                        <h4>SEARCH</h4>
                        <div class="side_bar_search">
                            <div class="input-group stylish-input-group">
                                <input class="form-control" placeholder="Search" type="text">
                                <span class="input-group-addon">
                                    <button type="submit"><i class="fa fa-search" aria-hidden="true"></i></button>
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="side_bar_blog">
                        <h4>Báo giá</h4>
                        <p>Nhân viên thân thiện, dịch vụ uy tín - chất lượng - tiết kiệm, đảm bảo chính hãng. GigaShop sẽ hỗ trợ bạn!.</p>
                        <a class="btn sqaure_bt" href="@Url.Action("Service", "Home")">View Service</a>
                    </div>
                    <div class="side_bar_blog">
                        <h4>Dịch vụ</h4>
                        <div class="categary">
                            <ul>
                                <li><a href="it_data_recovery.html"><i class="fa fa-angle-right"></i> Sửa chữa</a></li>
                                <li><a href="it_computer_repair.html"><i class="fa fa-angle-right"></i> Lắp đặt</a></li>
                                <li><a href="it_mobile_service.html"><i class="fa fa-angle-right"></i> Bảo hành</a></li>
                                <li><a href="it_network_solution.html"><i class="fa fa-angle-right"></i> Bảo trì</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    document.getElementById('add-to-cart-btn').addEventListener('click', function () {
        const productId = document.getElementById('product-id').querySelector('span').innerText;
        const quantity = document.getElementById('quantity-input').value;
        body: JSON.stringify({
            productID: parseInt(productId), // Đảm bảo productId là số
            quantity: parseInt(quantity)   // Đảm bảo quantity là số
        })
        fetch('/api/cart/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
            },
            body: JSON.stringify({
                productID: parseInt(productId),
                quantity: parseInt(quantity)
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert(data.message); // Hiển thị thông báo thành công
                }
            })
            .catch(error => {
                console.error('Lỗi:', error);
                alert('Không thể thêm sản phẩm vào giỏ hàng. Vui lòng thử lại.');
            });
    });
</script>
<script>
        window.onload = function () {
        const productId = localStorage.getItem('ProductID');
        if (productId) {
            // Lấy thông tin sản phẩm từ API
            fetch(`/api/products/${productId}`)
                .then(response => response.json())
                .then(product => {
                    if (product) {
                        // Hiển thị thông tin sản phẩm
                        document.getElementById('product-name').innerText = product.name || 'Không có tên sản phẩm';
                        document.getElementById('product-price').innerText = (product.price || 0) + ' VND';
                        document.getElementById('product-description').innerText = product.description || 'Không có mô tả';
                        document.getElementById('product-specifications').innerText = product.specifications || 'Không có thông số kỹ thuật';

                        // Cập nhật thông tin ProductID
                        document.getElementById('product-id').querySelector('span').innerText = productId;

                        // Hiển thị đánh giá sao
                        document.getElementById('product-rating').innerHTML = getStarRating(product.rating || 0);

                        // Hiển thị hình ảnh sản phẩm
                        displayProductImage(productId);
                    } else {
                        console.log('Không tìm thấy sản phẩm với ID: ' + productId);
                    }
                })
                .catch(error => {
                    console.error('Lỗi khi lấy dữ liệu sản phẩm:', error);
                });

            // Lấy các đánh giá từ API
            fetch(`/home/getreviews?productId=${productId}`)
                .then(response => response.json())
                .then(reviews => {
                    const reviewsList = document.getElementById('reviews-list');
                    reviewsList.innerHTML = '';
                    reviews.forEach(review => {
                        const reviewItem = `
                            <div class="commant-text row">
                                <div class="col-lg-2 col-md-2 col-sm-4">
                                    <div class="profile">
                                        <img class="img-responsive" src="images/it_service/client1.png" alt="#">
                                    </div>
                                </div>
                                <div class="col-lg-10 col-md-10 col-sm-8">
                                    <h5>${review.userName}</h5>
                                    <p><span class="c_date">${new Date(review.createdAt).toLocaleDateString()}</span></p>
                                    <span class="rating">${getStarRating(review.rating)}</span>
                                    <p class="msg">${review.comment}</p>
                                </div>
                            </div>
                        `;
                        reviewsList.innerHTML += reviewItem;
                    });
                })
                .catch(error => {
                    console.error('Lỗi khi lấy đánh giá:', error);
                });
        }
    };

    // Hàm hiển thị sao đánh giá
    function getStarRating(rating) {
        let starsHtml = '';
        for (let i = 1; i <= 5; i++) {
            if (i <= rating) {
                starsHtml += '<i class="fa fa-star" aria-hidden="true"></i>';
            } else {
                starsHtml += '<i class="fa fa-star-o" aria-hidden="true"></i>';
            }
        }
        return starsHtml;
    }

    // Hiển thị ảnh sản phẩm
    function displayProductImage(productId) {
        fetch('/api/images/products')
            .then(response => response.json())
            .then(images => {
                const formattedProductId = String(productId).padStart(2, '0');
                const matchedImage = images.find(image => image.startsWith(formattedProductId));
                const fallbackImage = '/images/default.jpg';

                if (matchedImage) {
                    document.getElementById('product-image').src = `/images/Products/${matchedImage}`;
                    document.getElementById('product-image').alt = 'Product Image';
                } else {
                    document.getElementById('product-image').src = fallbackImage;
                    document.getElementById('product-image').alt = 'Default Product Image';
                }
            })
            .catch(error => {
                console.error('Lỗi khi lấy ảnh sản phẩm:', error);
            });
    }
    // Optional: Cập nhật thông báo khi người dùng chọn đánh giá
    document.getElementById('ratingSelect').addEventListener('change', function() {
        var selectedRating = this.value;
        console.log("Đánh giá của bạn: " + selectedRating);
    });
</script>